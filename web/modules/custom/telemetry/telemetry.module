<?php

/**
 * @file
 * Primary module hooks for telemetry module.
 */

declare(strict_types=1);

namespace Drupal\telemetry;

use Drupal\telemetry\Module\TelemetryModule as Telemetry;

final class Module {

  use Telemetry;

  const TABLE_NAME = 'telemetry';

  const TABLE_FIELDS = [
    'id' => [
      'type'     => 'serial',
      'not null' => TRUE,
    ],
    'message' => [
      'type'        => 'text',
      'not null'    => TRUE,
      'description' => 'Message content.',
      '#type'       => 'textarea',
      '#title'      => 'Message',
    ],
    'message_type' => [
      'type'        => 'varchar',
      'length'      => 16,
      'not null'    => TRUE,
      'description' => 'Message type.',
      '#type'       => 'select',
      '#title'      => 'Select the message type',
      '#options'    => [
        'addMessage' => 'Message',
        'addError'   => 'Error',
        'addStatus'  => 'Status',
        'addWarning' => 'Warning',
      ],
    ],
  ];


  /**
   * message
   *
   * Hook to send the Drupal message also to the Telemetry.
   *
   * @param  mixed $type    Type of the message (see Drupal class Messenger for more information https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Messenger%21Messenger.php/class/Messenger/10).
   * @param  mixed $method  Originary method.
   * @param  mixed $message Message.
   * @return void
   */
  private static function message(string $type = 'Status', string $method = '', string $message = ''): void {
    \Drupal::messenger()->{"add{$type}"}(self::telemetry($type, $method, $message));
  }

  /**
   * extractSchema
   *
   * Extracts given schema for database usage.
   *
   * @param  array $array Schema to be filtered.
   * @return array Filtered schema.
   */
  public static function extractSchema(array $array = []): array {
    foreach ($array as $field => $sub) {
      foreach ($sub as $index => $val) {
        if ($index[0] === '#') {
          unset($array[$field][$index]);
        }
      }
    }
    return $array;
  }

  /**
   * extractFields
   *
   * Extracts schema and translates given fields.
   *
   * @param  array    $array               Schema to be filtered.
   * @param  array    $selected            Selected filter.
   * @param  callable $translator_callback Callback to translator method.
   * @param  array    $translate_fields    Look for translate this fields.
   * @return array Extracted and translated schema.
   */
  public static function extractFields(array $array, array $selected, callable $translator_callback, array $translate_fields = ['#title', '#options']): array {
    foreach ($array as $field => $options) {
      if (!in_array($field, $selected)) {
        unset($array[$field]);
        continue;
      }

      $array[$field]['#required'] = $array[$field]['not null'];

      foreach ($options as $key => $value) {
        if ($key[0] !== '#') {
          unset($array[$field][$key]);
        }
      }
    }

    foreach ($array as $field => $options) {
      foreach ($options as $option => $value) {
        if (in_array($option, $translate_fields)) {
          if (gettype($value) === 'string') {
            $array[$field][$option] = $translator_callback($value);
          }
          if (gettype($value) === 'array') {
            foreach ($value as $sub => $data) {
              $array[$field][$option][$sub] = $translator_callback($data);
            }
          }
        }
      }
    }
    return $array;
  }

  /**
   * install
   *
   * Performs module instalation.
   *
   * @return void
   */
  public static function install(): void {
    try {
      \Drupal::database()
        ->schema()
        ->createTable(self::TABLE_NAME, [
          'fields' => self::extractSchema(self::TABLE_FIELDS),
          'primary key' => ['id'],
        ]);
    } catch (\Throwable $th) {
      self::message('Error', __METHOD__, 'Error creating ' . self::TABLE_NAME . ': '. $th->getMessage());
    } finally {
      self::message('Status', __METHOD__, 'Table ' . self::TABLE_NAME . ' created.');
    }
  }

  /**
   * uninstall
   *
   * Performs module uninstall.
   *
   * @return void
   */
  public static function uninstall(): void {
    try {
      \Drupal::database()->schema()->dropTable(self::TABLE_NAME);
    } catch (\Throwable $th) {
      self::message('Error', __METHOD__, 'Error deleting ' . self::TABLE_NAME . ': '. $th->getMessage());
    } finally {
      self::message('Status', __METHOD__, 'Table ' . self::TABLE_NAME . ' deleted.');
    }
  }
}
